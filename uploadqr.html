<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Upload QR | Expiry Tracker</title>
    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-[#fefae0] text-[#2c3e50] font-sans">
    <!-- Navbar -->
    <nav
      class="bg-gradient-to-r from-green-600 to-teal-500 text-white px-6 py-4 flex justify-between items-center shadow"
    >
      <h1 class="text-xl font-bold">üì∑ Upload QR Code</h1>
      <a href="index.html" class="text-white underline">‚Üê Back to Dashboard</a>
    </nav>

    <!-- Container -->
    <div
      class="max-w-2xl mx-auto mt-10 bg-white p-6 rounded-xl shadow space-y-6"
    >
      <!-- Upload QR -->
      <section>
        <h2 class="text-lg font-semibold mb-2">Upload QR Code Image</h2>
        <input
          type="file"
          id="qr-file"
          accept="image/*"
          class="w-full p-2 border rounded"
        />
        <p class="text-sm text-gray-600 mt-2">Accepted format: .png, .jpg</p>
      </section>

      <!-- Autofill Form -->
      <form id="qrForm" class="space-y-4 hidden">
        <h2 class="text-lg font-semibold">Autofilled Product Details</h2>
        <input
          type="text"
          id="productName"
          placeholder="Product Name"
          class="w-full px-4 py-2 border rounded"
          required
        />
        <input
          type="date"
          id="expiryDate"
          class="w-full px-4 py-2 border rounded"
          required
        />
        <input
          type="number"
          id="quantity"
          placeholder="Quantity"
          class="w-full px-4 py-2 border rounded"
          required
        />
        <button
          type="submit"
          class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600"
        >
          ‚úÖ Save to Database
        </button>
      </form>
    </div>

    <!-- QR Decode + Form Submission Script -->
    <script>
      document.getElementById("qr-file").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const qrReader = new Html5Qrcode("qr-reader-temp");
        qrReader
          .scanFile(file, true)
          .then((decodedText) => {
            const parts = decodedText.split("|");

            if (parts.length !== 3) {
              alert("‚ùå Invalid QR format. Use: name|expiry|quantity");
              return;
            }

            // Autofill the form
            document.getElementById("productName").value = parts[0];
            document.getElementById("expiryDate").value = parts[1];
            document.getElementById("quantity").value = parts[2];

            document.getElementById("qrForm").classList.remove("hidden");
          })
          .catch(() => {
            alert("‚ùå Failed to read QR. Try again with a valid image.");
          });
      });

      // Submit Form to Backend
      document.getElementById("qrForm").addEventListener("submit", (e) => {
        e.preventDefault();

        const product = {
          name: document.getElementById("productName").value,
          expiryDate: document.getElementById("expiryDate").value,
          quantity: parseInt(document.getElementById("quantity").value),
        };

        fetch("http://localhost:8080/api/products", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(product),
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to add");
            alert("‚úÖ Product added to database!");
            e.target.reset();
            document.getElementById("qrForm").classList.add("hidden");
          })
          .catch((err) => {
            alert("‚ùå Error saving product");
            console.error(err);
          });
      });
    </script>

    <!-- Hidden QR container -->
    <div id="qr-reader-temp" style="display: none"></div>
 ¬†</body>
</html>